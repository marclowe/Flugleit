<!-- templates/home.html -->
{% extends 'base.html' %}

{% block title %}Home{% endblock %}

{% block content %}
{% csrf_token %}
{% if user.is_authenticated %}
  <h3 id=>Hi {{ user.username }}!</h3>
  <p><a href="{% url 'logout' %}">Log Out</a></p>
{% else %}
  <p>You are not logged in</p>
  <a href="{% url 'login' %}">Log In</a> |
  <a href="{% url 'signup' %}">Sign Up</a>
{% endif %}

<body>
    <div class="flight_search" id='app'>
        <h1>Look up flights</h1>
        <div id="dep_lookup">
        <label for="dep_airport">Departure Airport?</label>
            <input @input="getDepAirport" type="text" id="dep_airport" v-model="departureEntry" placeholder="enter city or airport code">
              <div v-if="departureAirport">
              <div v-for="item in departureAirport.slice(0, 10)" :key="item.id" id="dep_airport_entry":value = "item.codeIataAirport">[[item.nameAirport]] [[item.codeIataAirport]] <button @click="setDep(item.codeIataAirport, item.nameAirport)"> ✔</button></div>
              </div>
        </div>
        <div id="dep_lookup">
          <label for="dep_airport">Arrival Airport?</label>
              <input @input="getArrAirport" type="text" id="arr_airport" v-model="arrEntry" placeholder="enter city or airport code">
                <div v-if="arrAiport">
                <div v-for="item in arrAiport.slice(0, 10)" :key="item.id" id="arr_airport_entry":value = "item.codeIataAirport">[[item.nameAirport]] [[item.codeIataAirport]] <button @click="setArr(item.codeIataAirport, item.nameAirport)"> ✔</button></div>
                </div>
        </div>
          <label for="dep_date">Enter Dep Date:</label>
          <input type="date" id="start" name="dep_date"
           value="2021-01-01" v-model="datetime"
           min="2021-01-01" max="2031-12-31">
          <br><br><button @click="formatDate">Find Flights</button>  <button @click="clearForm">clear</button>
    
        <div v-if="scheduledFlights" id="display_flights">
          <h3 v-if="depAirportInfo" id="date">Current Time [[departureAirportCode]]: [[depAirportInfo[0].formattedAirportLocal]]</h3>
          <h4 id="flight_date"> Flight Date: [[datetime]]</h4>
          
          <ul v-for="flight in scheduledFlights" id="flightlist" :key="flight.flightNumber">
              <li> Dep: [[flight.departureAirportFsCode]] [[flight.formattedDeparture]] Arr: [[flight.arrivalAirportFsCode]] [[flight.formattedArrival]] [[flight.carrierFsCode]] [[flight.flightNumber]] Aircraft Type: [[flight.flightEquipmentIataCode]] <button v-if ="flight.displayInfo === true"  @click="collapseFlight">collapse</button> 
                  <button v-if ="flight.displayInfo === false" @click="getFlightStatus(flight)">Check Flight Status</button>
                  <div class= "flight_info" v-if ="flight.displayInfo"> 
                    <!-- <div>[[today]]</div> -->
                    <div class= "flight_info" v-if = "flightStatus[0].airportResources.departureGate" id="Departure_Gate">Departure Gate: [[flightStatus[0].airportResources.departureGate]]</div>
                      <div class = "flight_info_none" v-else>No Departure Gate Information</div>
                    <div class= "flight_info" v-if = "flightStatus[0].airportResources.arrivalGate" id="Arrival_Gate">Arrival Gate: [[flightStatus[0].airportResources.arrivalGate]]</div>
                      <div class = "flight_info_none" v-else>No Arrival Gate Information</div>
                    <div class= "flight_info" v-if = "flightStatus[0].airportResources.baggage" id="Baggage_Claim">Baggage Claim: [[flightStatus[0].airportResources.baggage]]</div>
                      <div class = "flight_info_none" v-else>No Baggage Information</div>
                    <div class= "flight_info" v-if="flightStatus[0].formatEstimatedDeparture"id="delays">Scheduled Dep: [[flightStatus[0].formatScheduledDeparture]] Estimated Dep:[[flightStatus[0].formatEstimatedDeparture]]</div>
                      <div class = "flight_info_none" v-else>No Departure Delay Information</div>
                    <div class= "flight_info" v-if="flightStatus[0].formatEstimatedArrival" id="delays">Scheduled Arr: [[flightStatus[0].formatScheduledArrival]] Estimated Arr:[[flightStatus[0].formatEstimatedArrival]]</div>
                      <div class = "flight_info_none" v-else>No Arrival Delay Information</div>
                  </div>
              </li>
          </ul>
        </div>
        

    </div>
  

<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<script src="https://unpkg.com/vue"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>

<script>
    
    let app = new Vue({
        el: '#app',
        
        delimiters: ['[[', ']]'],
        data: {
            
            departureAirportCode: '',
            arrivalAirportCode:'',
            departureAirport:'',
            arrAiport:'',
            departureEntry:'',
            arrEntry:'',
            depAirportInfo:'',
            // today: moment(Date),
            scheduledFlights:'',
            flightStatus:[{}],
            datetime:'',
            year:'',
            month:'',
            day:'',
            csrf_token: "",
            },
        filters: {
              moment
        },
        methods: {
            setDep: function(iataCode,nameAirport){
                  console.log(iataCode)
                  this.departureAirportCode = iataCode
                  this.departureEntry = iataCode
                  this.departureAirport=''
            },
            setArr: function(iataCode,nameAirport){
                  console.log(iataCode)
                  this.arrivalAirportCode = iataCode
                  this.arrEntry = iataCode
                  this.arrAiport=''
            },
         
            collapseFlight: function(){
              for (i = 0, len = this.scheduledFlights.length, text = ""; i < len; i++) {
                            this.scheduledFlights[i].displayInfo = false;
                      }
            },
            clearForm: function(){
                  this.departureAirportCode = '',
                  this.arrivalAirportCode = '',
                  this.scheduledFlights ='',
                  this.flightStatus =[{}],
                  this.datetime ='',
                  this.year = '',
                  this.month ='',
                  this.day ='',
                  this.departureEntry='',
                  this.departureAirport='',
                  this.arrEntry=''

            },
            formatDate: function(){
                this.year = moment(this.datetime).format("YYYY")
                this.month = moment(this.datetime).format("MM")
                this.day = moment(this.datetime).format("DD")
                console.log(this.year,this.month,this.day)
                this.getFlights()
            },
            getDepAirport: function(){
                        
                        axios({
                         // url:'http://aviation-edge.com/v2/public/timetable?',
                         // url:'http://api.aviationstack.com/v1/flights',
                         url:`http://aviation-edge.com/v2/public/autocomplete?`,
         
                         method: "get",
         
                         headers:{
                                  
                         //   "Authorization": `Token token="a51b4c035f2554ba87f3e30c52f9105e"`
                         },
                         params: {
                              key:'03dff0-0eaa8d',
                              city:this.departureEntry,
                         },
                    }).then(response =>{this.departureAirport = response.data.airportsByCities
                                      .filter(flight => flight.nameAirport.toLowerCase().includes(this.departureEntry.toLowerCase())
                                      ||this.departureEntry.toLowerCase().includes(flight.codeIataCity.toLowerCase())
                                      ||this.departureEntry.toLowerCase() === flight.codeIataAirport.toLowerCase()
                                      // ||this.departureEntry.toLowerCase() === flight.nameCity.toLowerCase())
                                      )

                                      
                           console.log(response.data)
                           }).catch(error => console.log(error))
                 },
            getArrAirport: function(){
                        
                        axios({
                         // url:'http://aviation-edge.com/v2/public/timetable?',
                         // url:'http://api.aviationstack.com/v1/flights',
                         url:`http://aviation-edge.com/v2/public/autocomplete?`,
         
                         method: "get",
         
                         headers:{
                                  
                         //   "Authorization": `Token token="a51b4c035f2554ba87f3e30c52f9105e"`
                         },
                         params: {
                              key:'03dff0-0eaa8d',
                              city:this.arrEntry,
                         },
                             
                   }).then(response =>{this.arrAiport=response.data.airportsByCities
                    .filter(flight => flight.nameAirport.toLowerCase().includes(this.arrEntry.toLowerCase())
                    ||this.arrEntry.toLowerCase().includes(flight.codeIataCity.toLowerCase())
                    ||this.arrEntry.toLowerCase() === flight.codeIataAirport.toLowerCase() )
                    console.log(response.data)
                       }).catch(error => console.log(error))
                 },
            getFlights: function(){
                        
                       axios({
                        // url:'http://aviation-edge.com/v2/public/timetable?',
                        // url:'http://api.aviationstack.com/v1/flights',
                        url:`https://flightstats-api.herokuapp.com/flex/schedules/rest/v1/json/from/${this.departureAirportCode}/to/${this.arrivalAirportCode}/departing/${this.year}/${this.month}/${this.day}?appId=3c14b40b&appKey=1f6e49c1000c59e4ecd064b9c377fc64`,
        
                        method: "get",
        
                        headers:{
                                 
                        //   "Authorization": `Token token="a51b4c035f2554ba87f3e30c52f9105e"`
                        },
                        params: {
                        
                        },
                            
                  }).then(response =>{
                       console.log(response.data)
                       this.scheduledFlights = response.data.scheduledFlights.filter(flight => flight.isCodeshare === false)
                      .map(flight=>{
                        flight.formattedDeparture = moment(flight.departureTime).format("h:mm a")
                        flight.formattedArrival = moment(flight.arrivalTime).format(" h:mm a")
                        flight.displayInfo = false
                        return flight
                      })
                      // console.log('it worked', this.scheduledFlights)
                      this.scheduledFlights.sort(function (x, y) {
                                                        let a = new Date(x.departureTime),
                                                            b = new Date(y.departureTime);
                                                        return a - b;
                                                    }); 
                      this.getDepAirportInfo()                   
                      }).catch(error => console.log(error))
                },
                getFlightStatus: function(flight){
                        
                        axios({
                         // url:'http://aviation-edge.com/v2/public/timetable?',
                         // url:'http://api.aviationstack.com/v1/flights',
                         url:`https://flightstats-api.herokuapp.com/flex/flightstatus/rest/v2/json/flight/status/${flight.carrierFsCode}/${flight.flightNumber}/dep/${this.year}/${this.month}/${this.day}?appId=3c14b40b&appKey=1f6e49c1000c59e4ecd064b9c377fc64&utc=false`,
                        //  url:`https://flightstats-api.herokuapp.com/flex/flightstatus/rest/v1/json/flight/status/UA/419/dep/${this.year}/${this.month}/${this.day}?appId=3c14b40b&appKey=199b458d7a0a576ec2ea3257ca83e2c8&utc=false`,

                         method: "get",
         
                         headers:{
                                  
                         //   "Authorization": `Token token="a51b4c035f2554ba87f3e30c52f9105e"`
                         },
                         params: {
                                 
                         },
                             
                   }).then(response =>{
                       console.log(response.data)
                       this.flightStatus = response.data.flightStatuses
                       .filter(flight =>(flight.departureAirportFsCode === this.departureAirportCode && flight.arrivalAirportFsCode === this.arrivalAirportCode))
                       .map(flight=>{
                        if (flight.operationalTimes.scheduledGateDeparture){flight.formatScheduledDeparture = moment(flight.operationalTimes.scheduledGateDeparture.dateLocal).format("h:mm a")};
                        if(flight.operationalTimes.estimatedGateDeparture){flight.formatEstimatedDeparture = moment(flight.operationalTimes.estimatedGateDeparture.dateLocal).format(" h:mm a")};
                        if(flight.operationalTimes.scheduledGateArrival){flight.formatScheduledArrival = moment(flight.operationalTimes.scheduledGateArrival.dateLocal).format("h:mm a")};
                        if(flight.operationalTimes.estimatedGateArrival){flight.formatEstimatedArrival = moment(flight.operationalTimes.estimatedGateArrival.dateLocal).format(" h:mm a")};
                        if(flight.operationalTimes.actualGateDeparture){flight.formatActualDeparture = moment(flight.operationalTimes.actualGateDeparture.dateLocal).format(" h:mm a")}
                        return flight
                      })
                       for (i = 0, len = this.scheduledFlights.length, text = ""; i < len; i++) {
                            this.scheduledFlights[i].displayInfo = false;
                      }
                      flight.displayInfo = true
                      console.log(response)
                      })
                      
                 },
                 getDepAirportInfo: function(){
                        
                        axios({
                         url:`https://flightstats-api.herokuapp.com/flex/airports/rest/v1/json/iata/${this.departureAirportCode}?appId=3c14b40b&appKey=1f6e49c1000c59e4ecd064b9c377fc64`,
         
                         method: "get",
         
                         headers:{
                        },
                         params: {
                         },
                             
                   }).then(response =>{
                    this.depAirportInfo = response.data.airports
                       .map(flight=>{
                         flight.formattedAirportLocal = moment(flight.localTime).format("MM/DD/YYYY h:mm a")
                        return flight
                       })
 
                      })
                  },

        }
         
    });
</script>
{% endblock %}
